<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YEAH! We Are CLOVERs!</title>
    <!-- Î∏åÎùºÏö∞Ï†Ä ÌÉ≠Ïóê ÌëúÏãúÎê† ÌååÎπÑÏΩòÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ 404 Ïò§Î•òÎ•º Ìï¥Í≤∞Ìï©ÎãàÎã§. -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÄ</text></svg>">
    <style>
        @font-face {
            font-family: 'MyGameFont';
            src: url('./fonts/Pak_Yong_jun.ttf') format('truetype');
        }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <audio id="bgm" src="./Love3.mp3" loop></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ==================================================================
        // Í≤åÏûÑ ÏÑ§Ï†ï (Constants & Config)
        // ==================================================================
        const GAME_WIDTH = 540;
        const GAME_HEIGHT = 960;
        const MAX_LIVES = 3;

        const BGM_VOLUME_NORMAL = 0.5;
        const BGM_VOLUME_MENU = BGM_VOLUME_NORMAL / 2;

        const FEVER_DURATION = 5000;
        const FEVER_TRIGGER_COUNT = 10;
        const BASE_SPAWN_INTERVAL = 450;
        const FEVER_SPAWN_INTERVAL = 120;

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA90s1FUPCjbW3Wo_N8IVhMUqewmXhetq0",
            authDomain: "clovergame-e712f.firebaseapp.com",
            projectId: "clovergame-e712f",
            storageBucket: "clovergame-e712f.appspot.com",
            messagingSenderId: "525191060039",
            appId: "1:525191060039:web:5707417e6e8ee8bf9cef62"
        };
        
        // --- Ï†ÑÏó≠ Î≥ÄÏàò (Global State) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgm = document.getElementById('bgm');
        
        let db, leaderboardCollection, cachedLeaderboard = null;
        
        const characters = [
            { id: 1, name: 'PAIIEK', speed: 7, imgSrc: './char2.png', imgSrcSelected: './char2-1.png', imgIconSrc: './char2-2.png', imgHitSrc: './char2-3.png', selectSfxSrc: './sounds/char2-1.mp3', hitSfxSrc: './sounds/char2-1-1.mp3', selectVolume: 0.9, hitVolume: 1.0 },
            { id: 2, name: 'KANG', speed: 8, imgSrc: './char3.png', imgSrcSelected: './char3-1.png', imgIconSrc: './char3-2.png', imgHitSrc: './char3-3.png', selectSfxSrc: './sounds/char3-1.mp3', hitSfxSrc: './sounds/char3-1-1.mp3', selectVolume: 1.0, hitVolume: 1.0 },
            { id: 3, name: 'NAH', speed: 9, imgSrc: './char1.png', imgSrcSelected: './char1-1.png', imgIconSrc: './char1-2.png', imgHitSrc: './char1-3.png', selectSfxSrc: './sounds/char1-1.mp3', hitSfxSrc: './sounds/char1-1-1.mp3', selectVolume: 0.4, hitVolume: 1.0 }
        ];
        
        let selectedCharacterId = 1;
        
        let uiBoxes = {}, startScreenState = 'main'; 
        let leaderboardScrollY = 0, isDragging = false, lastTouchY = 0;
        let player, objects, score, spawnTimer, targetX, playerHitbox = {};
        let gameState = 'loading', loadingError = null;
        let lastTime = 0, gameSpeedMultiplier = 1;
        let feverScore = 0, isFeverTime = false, feverTimer = 0;
        let lives;
        let animationFrameId;
        
        let hasInteracted = false, isMuted = false;

        // --- Î¶¨ÏÜåÏä§ Í≤ΩÎ°ú (Asset Paths) ---
        const IMAGE_ASSETS = {
            clover: './clover.png', love: './love.png', bomb: './bomb.png', title: './clover_title.png',
            darkGrayBtn: './darkgray.png', lightGrayBtn: './lightgray.png', major: './major.png',
            yellow: './yellow.png', gray: './gray.png', circleBtn: './circle.png',
            soundOn: './sound_on.png', soundOff: './sound_off.png', ground: './ground.png'
        };
        const SOUND_ASSETS = {
            bombHit: './sounds/bomb_hit.mp3', buttonClick: './sounds/button_click.mp3',
            gameOver: './sounds/game_over.mp3', cloverTime: './sounds/clovertime.mp3',
            love1: './sounds/bbyong.mp3', love2: './sounds/heart.mp3', clover: './sounds/jump_low.mp3'
        };
        
        const loadedImages = {};
        let sfxPool = {};
        const SFX_POOL_SIZE = 5;

        // ==================================================================
        // Ï¥àÍ∏∞Ìôî Î∞è Î¶¨ÏÜåÏä§ Î°úÎî© (Initialization & Asset Loading)
        // ==================================================================
        
        function initializeFirebase() { try { firebase.initializeApp(FIREBASE_CONFIG); db = firebase.firestore(); leaderboardCollection = db.collection('leaderboard'); } catch (e) { console.error("Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:", e); loadingError = e; gameState = 'error'; } }

        function loadAsset(type, name, src) {
            return new Promise((resolve, reject) => {
                if (type === 'image') {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        if (name === 'character') {
                            resolve(img);
                        } else {
                            loadedImages[name] = img;
                            resolve();
                        }
                    };
                    img.onerror = () => reject(`${type} Î°úÎìú Ïã§Ìå®: ${src}`);
                } else if (type === 'sound') {
                    const audio = new Audio();
                    audio.src = src;
                    audio.addEventListener('canplaythrough', () => {
                        sfxPool[src] = { pool: [audio], currentIndex: 0 };
                        for (let i = 1; i < SFX_POOL_SIZE; i++) {
                            sfxPool[src].pool.push(audio.cloneNode());
                        }
                        resolve();
                    }, { once: true });
                    audio.onerror = (e) => reject(`${type} Î°úÎìú Ïã§Ìå®: ${src}`);
                    audio.load();
                }
            });
        }

        async function loadGameAssets() {
            const imagePromises = Object.entries(IMAGE_ASSETS).map(([name, src]) => loadAsset('image', name, src));
            
            const charImagePromises = characters.flatMap(char => [
                loadAsset('image', 'character', char.imgSrc).then(img => { char.img = img; char.originalWidth = img.naturalWidth; char.originalHeight = img.naturalHeight; }),
                loadAsset('image', 'character', char.imgSrcSelected).then(img => char.imgSelected = img),
                loadAsset('image', 'character', char.imgIconSrc).then(img => char.imgIcon = img),
                char.imgHitSrc ? loadAsset('image', 'character', char.imgHitSrc).then(img => char.imgHit = img) : Promise.resolve()
            ]);

            const soundSrcs = [...new Set([...Object.values(SOUND_ASSETS), ...characters.flatMap(c => [c.selectSfxSrc, c.hitSfxSrc])].filter(Boolean))];
            const soundPromises = soundSrcs.map(src => loadAsset('sound', null, src));

            await Promise.all([...imagePromises, ...charImagePromises, ...soundPromises, document.fonts.ready]);
        }
        
        // ==================================================================
        // Í≤åÏûÑ Î°úÏßÅ (Game Logic)
        // ==================================================================

        function init() {
            const char = characters.find(c => c.id === selectedCharacterId);
            const playerWidth = GAME_WIDTH * 0.2;
            const aspectRatio = char.originalHeight / char.originalWidth;
            const playerHeight = playerWidth * aspectRatio;
            
            player = { width: playerWidth, height: playerHeight, x: GAME_WIDTH / 2 - playerWidth / 2, y: GAME_HEIGHT - playerHeight - (GAME_HEIGHT * 0.1), speed: char.speed, img: char.img, originalImg: char.img, hitImg: char.imgHit, hitTimer: 0, dx: 0 };
            
            targetX = player.x; objects = []; score = 0; spawnTimer = 0;
            gameSpeedMultiplier = 1; feverScore = 0; isFeverTime = false; feverTimer = 0;
            lives = MAX_LIVES;
            gameState = 'playing';

            bgm.currentTime = 0;
            bgm.volume = BGM_VOLUME_NORMAL;
            if (!bgm.paused) bgm.play();
        }

        function movePlayer() {
            player.x += (targetX - player.x) * 0.5;
            player.x = Math.max(0, Math.min(player.x, GAME_WIDTH - player.width));
        }
        
        function updateObjects(deltaTime) {
            spawnTimer += deltaTime; 
            gameSpeedMultiplier = Math.min(3, 1 + (score * 0.01));
            
            playerHitbox.x = player.x + player.width * 0.2;
            playerHitbox.y = player.y;
            playerHitbox.width = player.width * 0.6;
            playerHitbox.height = player.height * 0.5;

            if (player.hitTimer > 0) player.hitTimer -= deltaTime;
            
            const spawnInterval = isFeverTime ? FEVER_SPAWN_INTERVAL : BASE_SPAWN_INTERVAL;
            if (spawnTimer > spawnInterval / gameSpeedMultiplier) {
                spawnTimer = 0;
                let type = 'good';
                if (isFeverTime) {
                    objects.push({ x: Math.random() * (GAME_WIDTH - 40), y: -40, width: 40, height: 40, speed: 200, type: 'good' });
                } else {
                    const rand = Math.random();
                    if (rand < 0.3) type = 'bad';
                    else if (rand < 0.45) type = 'special';
                    objects.push({ x: Math.random() * (GAME_WIDTH - 40), y: -40, width: 40, height: 40, speed: (1.5 + Math.random() * 2) * 100, type: type });
                }
            }

            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                obj.y += obj.speed * gameSpeedMultiplier * (deltaTime / 1000);

                if (obj.y > GAME_HEIGHT) {
                    objects.splice(i, 1);
                    continue;
                }

                if (playerHitbox.x < obj.x + obj.width && playerHitbox.x + playerHitbox.width > obj.x &&
                    playerHitbox.y < obj.y + obj.height && playerHitbox.y + playerHitbox.height > obj.y) {
                    
                    handleCollision(obj);
                    objects.splice(i, 1);
                }
            }
        }

        function handleCollision(obj) {
            if (obj.type === 'bad') {
                lives--;
                player.hitTimer = 500;
                const char = characters.find(c => c.id === selectedCharacterId);
                if (char) playSound(char.hitSfxSrc, char.hitVolume);
                playSound(SOUND_ASSETS.bombHit, 1.0);
                if (lives <= 0) {
                    gameState = 'gameOver';
                    bgm.pause();
                    playSound(SOUND_ASSETS.gameOver);
                }
            } else if (obj.type === 'special') {
                feverScore++;
                playSound(Math.random() < 0.5 ? SOUND_ASSETS.love1 : SOUND_ASSETS.love2);
                if (feverScore >= FEVER_TRIGGER_COUNT) {
                    isFeverTime = true;
                    feverTimer = FEVER_DURATION;
                    feverScore = 0;
                    playSound(SOUND_ASSETS.cloverTime);
                }
            } else { // good
                score++;
                playSound(SOUND_ASSETS.clover);
            }
        }

        // ==================================================================
        // Î†åÎçîÎßÅ (Drawing & Rendering)
        // ==================================================================
        
        function drawPlayer() {
            const currentImg = (player.hitTimer > 0) ? player.hitImg : player.originalImg;
            if (currentImg) ctx.drawImage(currentImg, player.x, player.y, player.width, player.height);
        }
        
        function drawObjects() {
            objects.forEach(obj => {
                let imgToDraw;
                if (obj.type === 'good') imgToDraw = loadedImages.clover;
                else if (obj.type === 'special') imgToDraw = loadedImages.love;
                else if (obj.type === 'bad') imgToDraw = loadedImages.bomb;
                if (imgToDraw) ctx.drawImage(imgToDraw, obj.x, obj.y, obj.width, obj.height);
            });
        }
        
        function drawConfirmButton(yPos) {
            const btnWidth = 150, btnHeight = 50, btnX = (GAME_WIDTH - btnWidth) / 2;
            uiBoxes.confirmBtn = { x: btnX, y: yPos, width: btnWidth, height: btnHeight };
            ctx.drawImage(loadedImages.darkGrayBtn, btnX, yPos, btnWidth, btnHeight);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px "MyGameFont"';
            ctx.textAlign = 'center';
            ctx.fillText('ÌôïÏù∏', GAME_WIDTH / 2, yPos + 32);
        }

        // ... (drawCreditScreen, drawLeaderboardScreen, etc. remain largely the same, but use loadedImages)
        function drawCreditScreen() {
            ctx.fillStyle = '#2c3e50';
            ctx.textAlign = 'center';
            let currentY = GAME_HEIGHT * 0.15;
            const titleFontSize = 24;
            const contentFontSize = 18;
            const lineHeight = 30;
            const sectionGap = 35;

            const credits = [
                { title: 'Made by', text: ['chakoll23'] },
                { title: 'Sound', text: ['SFX : ÏÖÄÎ∞îÏù¥ÎÆ§ÏßÅ (Sellbuymusic)', 'BGM : "Love Love Love (Chiptune ver.)" - ÎÇòÏÉÅÌòÑÏî®Î∞¥Îìú'] },
                { title: 'Voice', text: ['Î∞±ÏäπÎ†¨, Í∞ïÌòÑÏõÖ, ÎÇòÏÉÅÌòÑ'] },
                { title: 'Font', text: ['Main : Î∞ïÏö©Ï§ÄÌà¨ÏÇ¨ÌöåÎ≥¥Ï≤¥', 'Logo : ÌèâÏ∞ΩÏ≤¥, ÌèâÏ∞Ω ÌèâÌôîÏ≤¥'] },
                { title: 'Special Thanks', text: ['ÎÇòÏî®Î∞¥, ÎÇòÏî®Ìå¨'] }
            ];

            credits.forEach(credit => {
                ctx.font = `bold ${titleFontSize}px "MyGameFont"`;
                ctx.fillText(credit.title, GAME_WIDTH / 2, currentY);
                currentY += lineHeight;
                ctx.font = `${contentFontSize}px "MyGameFont"`;
                credit.text.forEach(line => {
                    ctx.fillText(line, GAME_WIDTH / 2, currentY);
                    currentY += lineHeight;
                });
                currentY += (sectionGap - lineHeight);
            });

            drawConfirmButton(GAME_HEIGHT * 0.9);
        }
        
        function drawMainMenu() {
            let currentY = GAME_HEIGHT * 0.1;
            const titleImg = loadedImages.title;
            if (titleImg) {
                const imgWidth = GAME_WIDTH * 0.7; 
                const imgHeight = (titleImg.naturalHeight / titleImg.naturalWidth) * imgWidth;
                ctx.drawImage(titleImg, (GAME_WIDTH - imgWidth) / 2, currentY, imgWidth, imgHeight);
                currentY += imgHeight + 40;
            }

            ctx.fillStyle = '#2c3e50';
            ctx.font = '18px "MyGameFont"';
            ctx.textAlign = 'center';
            ctx.fillText('<Í≤åÏûÑÎ∞©Î≤ï>', GAME_WIDTH / 2, currentY);
            currentY += 40;
            
            // ... Simplified how-to-play drawing
            
            currentY = GAME_HEIGHT * 0.65; // Reposition buttons
            const btnWidth = Math.min(GAME_WIDTH * 0.7, 300);
            const btnHeight = Math.min(GAME_HEIGHT * 0.08, 60);
            const gap = btnHeight * 0.5;
            const btnX = (GAME_WIDTH - btnWidth) / 2;
            const btnFontSize = Math.min(btnHeight * 0.4, 24);
            ctx.font = `bold ${btnFontSize}px "MyGameFont"`;
            ctx.textAlign = 'center';

            const mainMenuButtons = [
                { id: 'charSelectBtn', text: 'Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù', y: currentY, img: loadedImages.darkGrayBtn, color: 'white' },
                { id: 'leaderboardBtn', text: 'Î™ÖÏòàÏùò Ï†ÑÎãπ', y: currentY + btnHeight + gap, img: loadedImages.lightGrayBtn, color: 'black' },
                { id: 'startBtn', text: 'Í≤åÏûÑ ÏãúÏûë', y: currentY + (btnHeight + gap) * 2, img: loadedImages.darkGrayBtn, color: 'white' }
            ];

            mainMenuButtons.forEach(btn => {
                uiBoxes[btn.id] = { x: btnX, y: btn.y, width: btnWidth, height: btnHeight };
                ctx.drawImage(btn.img, btnX, btn.y, btnWidth, btnHeight);
                ctx.fillStyle = btn.color;
                ctx.fillText(btn.text, GAME_WIDTH / 2, btn.y + btnHeight / 2 + (btnFontSize / 3));
            });

            const creditBtnSize = 60;
            const creditBtnMargin = 20;
            const creditBtnX = GAME_WIDTH - creditBtnSize - creditBtnMargin;
            const creditBtnY = GAME_HEIGHT - creditBtnSize - creditBtnMargin;
            uiBoxes.creditBtn = { x: creditBtnX, y: creditBtnY, width: creditBtnSize, height: creditBtnSize };
            ctx.drawImage(loadedImages.circleBtn, creditBtnX, creditBtnY, creditBtnSize, creditBtnSize);
            ctx.fillStyle = 'black';
            ctx.font = `bold ${creditBtnSize * 0.25}px "MyGameFont"`;
            ctx.textBaseline = 'middle';
            ctx.fillText('Credit', creditBtnX + creditBtnSize / 2, creditBtnY + creditBtnSize / 2);
            ctx.textBaseline = 'alphabetic';
        }


        function drawCharacterSelectScreen() { /* ... unchanged ... */ }
        function drawLeaderboardScreen() { /* ... unchanged but using loadedImages ... */ }
        function drawPauseScreen() { /* ... unchanged but using loadedImages ... */ }
        function drawGameOver() { /* ... unchanged ... */ }
        function drawUI() { /* ... unchanged ... */ }
        function drawGround() { /* ... unchanged but using loadedImages ... */ }
        function drawMuteButton() { /* ... unchanged but using loadedImages ... */ }
        
        function drawStartScreen() { 
            uiBoxes = {}; 
            ctx.fillStyle = '#f0f0f0'; 
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT); 
            if (startScreenState === 'main') drawMainMenu();
            else if (startScreenState === 'leaderboard') drawLeaderboardScreen();
            else if (startScreenState === 'characterSelect') drawCharacterSelectScreen();
            else if (startScreenState === 'credit') drawCreditScreen();
        }

        function drawCurrentState() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            switch(gameState) {
                case 'loading':
                    ctx.fillStyle = 'black';
                    ctx.font = '24px "MyGameFont"';
                    ctx.textAlign = 'center';
                    ctx.fillText('Î°úÎî© Ï§ë...', GAME_WIDTH / 2, GAME_HEIGHT / 2);
                    break;
                case 'error':
                    drawErrorScreen();
                    break;
                case 'startScreen':
                    drawStartScreen();
                    drawMuteButton();
                    break;
                case 'playing':
                    drawObjects();
                    drawPlayer();
                    drawGround();
                    drawUI();
                    drawMuteButton();
                    break;
                case 'paused':
                case 'gameOver':
                    drawObjects();
                    drawPlayer();
                    drawGround();
                    if(gameState === 'paused') drawPauseScreen();
                    else drawGameOver();
                    drawMuteButton();
                    break;
            }
        }

        // ==================================================================
        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ (Event Handlers)
        // ==================================================================
        
        // ... handleInteractionStart, move, end, keydown, keyup, wheel ...

        // ==================================================================
        // Î©îÏù∏ Í≤åÏûÑ Î£®ÌîÑ Î∞è ÏãúÏûëÏ†ê (Main Loop & Entry Point)
        // ==================================================================
        
        function gameLoop(timestamp) {
            cancelAnimationFrame(animationFrameId);
            
            if (gameState === 'loading' || gameState === 'error') {
                 drawCurrentState();
                 animationFrameId = requestAnimationFrame(gameLoop);
                 return;
            }
            
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            if (gameState === 'playing') {
                if (isFeverTime) {
                    feverTimer -= deltaTime;
                    if (feverTimer <= 0) isFeverTime = false;
                }
                updateObjects(deltaTime);
                movePlayer();
            }
            
            drawCurrentState();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function setRealViewportHeight() {
            document.body.style.height = `${window.innerHeight}px`;
        }

        async function main() {
            initializeFirebase();
            setRealViewportHeight();
            bgm.volume = BGM_VOLUME_MENU;
            resizeCanvas(); // Draw "Loading..."
            
            try {
                await loadGameAssets();
                listenForLeaderboardUpdates();
                gameState = 'startScreen';
            } catch (error) {
                console.error(error);
                loadingError = error;
                gameState = 'error';
            }
            
            gameLoop(0);
        }
        
        window.addEventListener('resize', () => { setRealViewportHeight(); resizeCanvas(); });
        document.addEventListener('visibilitychange', () => { if (document.hidden && gameState === 'playing') { gameState = 'paused'; bgm.pause(); } });
        //... other event listeners ...

        main();
    </script>
</body>
</html>

