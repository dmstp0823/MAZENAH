<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì˜¨ë¼ì¸ ìˆœìœ„ ê²½ìŸ! ë¬¼ì²´ í”¼í•˜ê¸°</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; } /* ê²€ì€ ë°°ê²½ */
        canvas { display: block; cursor: pointer; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <audio id="bgm" src="./Love3.mp3" loop></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ==================================================================
        // Firebase Config (ì‚¬ìš©ì ì •ë³´ë¡œ êµì²´)
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA90s1FUPCjbW3Wo_N8IVhMUqewmXhetq0",
            authDomain: "clovergame-e712f.firebaseapp.com",
            projectId: "clovergame-e712f",
            storageBucket: "clovergame-e712f.appspot.com",
            messagingSenderId: "525191060039",
            appId: "1:525191060039:web:5707417e6e8ee8bf9cef62"
        };
        // ==================================================================

        // --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgm = document.getElementById('bgm');
        
        // âœ¨ 1. ê²Œì„ ì„¸ê³„ì˜ ê³ ì •ëœ í¬ê¸° ì •ì˜ (9:16 ë¹„ìœ¨)
        const GAME_WIDTH = 540;
        const GAME_HEIGHT = 960;

        let db;
        let leaderboardCollection;
        let cachedLeaderboard = null;
        const characters = [
            { id: 1, name: 'ë¸”ë£¨', color: '#3498db', speed: 9, imgSrc: './char1.png', img: null },
            { id: 2, name: 'ê·¸ë¦°', color: '#2ecc71', speed: 7, imgSrc: './char2.png', img: null },
            { id: 3, name: 'í¼í”Œ', color: '#8e44ad', speed: 8, imgSrc: './char3.png', img: null }
        ];
        let selectedCharacterId = 1;
        let uiBoxes = {};
        let startScreenState = 'main'; 
        let leaderboardScrollY = 0;
        let isDragging = false;
        let lastTouchY = 0;
        let player, objects, score, spawnTimer, targetX;
        let gameState = 'loading';
        let lastTime = 0;
        let gameSpeedMultiplier = 1;
        let feverScore = 0, isFeverTime = false, feverTimer = 0;
        const FEVER_DURATION = 5000;
        const FEVER_TRIGGER_COUNT = 10;
        const BASE_SPAWN_INTERVAL = 450;
        const FEVER_SPAWN_INTERVAL = 120;
        let pauseButtonBox = {};
        let animationFrameId;

        // --- í•¨ìˆ˜ ì •ì˜ ---
        
        function initializeFirebase() { /* ì´ì „ê³¼ ë™ì¼ */ }
        function listenForLeaderboardUpdates() { /* ì´ì „ê³¼ ë™ì¼ */ }
        async function saveToLeaderboard(newScore, nickname) { /* ì´ì „ê³¼ ë™ì¼ */ }
        function loadImages() { /* ì´ì „ê³¼ ë™ì¼ */ }

        function init() {
            const selectedCharacter = characters.find(c => c.id === selectedCharacterId);
            const displayWidth = selectedCharacter.originalWidth;
            const displayHeight = selectedCharacter.originalHeight;
            const MAX_PLAYER_SIZE = 80;
            let playerWidth = displayWidth;
            let playerHeight = displayHeight;
            if (playerWidth > MAX_PLAYER_SIZE || playerHeight > MAX_PLAYER_SIZE) {
                const aspectRatio = displayWidth / displayHeight;
                if (aspectRatio > 1) { playerWidth = MAX_PLAYER_SIZE; playerHeight = MAX_PLAYER_SIZE / aspectRatio; }
                else { playerHeight = MAX_PLAYER_SIZE; playerWidth = MAX_PLAYER_SIZE * aspectRatio; }
            }
            player = {
                width: playerWidth, height: playerHeight,
                x: GAME_WIDTH / 2 - playerWidth / 2, 
                y: GAME_HEIGHT - playerHeight - (GAME_HEIGHT * 0.1),
                speed: selectedCharacter.speed, img: selectedCharacter.img, dx: 0
            };
            targetX = player.x; objects = []; score = 0; spawnTimer = 0;
            gameSpeedMultiplier = 1; feverScore = 0; isFeverTime = false; feverTimer = 0;
            gameState = 'playing';
            bgm.currentTime = 0;
            bgm.play();
        }
        
        // âœ¨ 2. í™”ë©´ í¬ê¸° ì¡°ì • ë° ì¢Œí‘œ ë³€í™˜ ë¡œì§ (í•µì‹¬)
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;

        function resizeCanvas() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            scale = Math.min(viewportWidth / GAME_WIDTH, viewportHeight / GAME_HEIGHT);
            
            const scaledWidth = GAME_WIDTH * scale;
            const scaledHeight = GAME_HEIGHT * scale;

            offsetX = (viewportWidth - scaledWidth) / 2;
            offsetY = (viewportHeight - scaledHeight) / 2;

            canvas.width = viewportWidth;
            canvas.height = viewportHeight;

            // ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ì„ ì§ì ‘ ì¡°ì ˆí•˜ì—¬ ì¤‘ì•™ì— ë°°ì¹˜
            canvas.style.position = 'absolute';
            canvas.style.left = `${offsetX}px`;
            canvas.style.top = `${offsetY}px`;
            canvas.style.width = `${scaledWidth}px`;
            canvas.style.height = `${scaledHeight}px`;

            drawCurrentState();
        }

        function getEventPos(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            // í™”ë©´ ì¢Œí‘œë¥¼ ê²Œì„ ì„¸ê³„ ì¢Œí‘œë¡œ ë³€í™˜
            const gameX = (clientX - offsetX) / scale;
            const gameY = (clientY - offsetY) / scale;
            return { x: gameX, y: gameY };
        }
        
        function isInside(pos, rect) { return rect && pos.x > rect.x && pos.x < rect.x + rect.width && pos.y > rect.y && pos.y < rect.y + rect.height; }
        
        // (ì´í•˜ ëª¨ë“  ê·¸ë¦¬ê¸° ë° ë¡œì§ í•¨ìˆ˜ë“¤ì€ GAME_WIDTH, GAME_HEIGHT ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œ ê³„ì‚°)
        
        function drawPlayer() { if (player && player.img) { ctx.drawImage(player.img, player.x, player.y, player.width, player.height); } }
        function drawObjects() { objects.forEach(obj => { ctx.fillStyle = obj.color; ctx.fillRect(obj.x, obj.y, obj.width, obj.height); }); }
        function drawConfirmButton(yPos) { const btnWidth = 150, btnHeight = 50; const btnX = (GAME_WIDTH - btnWidth) / 2; uiBoxes.confirmBtn = { x: btnX, y: yPos, width: btnWidth, height: btnHeight }; ctx.fillStyle = '#2980b9'; ctx.fillRect(btnX, yPos, btnWidth, btnHeight); ctx.fillStyle = 'white'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'center'; ctx.fillText('í™•ì¸', GAME_WIDTH / 2, yPos + 32); }
        
        function drawLeaderboardScreen() {
            ctx.fillStyle = '#34495e'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center';
            ctx.fillText('ğŸ† Top 10 ğŸ†', GAME_WIDTH / 2, GAME_HEIGHT * 0.1);
            const listStartY = GAME_HEIGHT * 0.15;
            const listHeight = GAME_HEIGHT * 0.7;
            const boxWidth = Math.min(GAME_WIDTH * 0.8, 350);
            const boxHeight = 40, gap = 10;
            if (cachedLeaderboard === null) { ctx.font = '20px Arial'; ctx.fillText('ë¡œë”© ì¤‘...', GAME_WIDTH / 2, listStartY + 50); }
            else if (cachedLeaderboard.length === 0) { ctx.font = '20px Arial'; ctx.fillText('ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!', GAME_WIDTH / 2, listStartY + 50); }
            else { /* ... ì´ì „ê³¼ ë™ì¼í•œ ìŠ¤í¬ë¡¤ ë° ê·¸ë¦¬ê¸° ë¡œì§ (ì¢Œí‘œ ê¸°ì¤€ë§Œ GAME_WIDTHë¡œ ë³€ê²½) ... */ }
            drawConfirmButton(GAME_HEIGHT * 0.9);
        }
        
        function drawCharacterSelectScreen() {
            ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center';
            ctx.fillText('ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”', GAME_WIDTH / 2, GAME_HEIGHT * 0.15);
            const displayCharSize = Math.min(GAME_WIDTH / 4, 100);
            const gap = 20; const totalWidth = (displayCharSize * characters.length) + (gap * (characters.length - 1));
            let startX = (GAME_WIDTH - totalWidth) / 2;
            const boxY = (GAME_HEIGHT - displayCharSize) / 2 - 50;
            uiBoxes.characterBoxes = [];
            characters.forEach(char => { /* ... ì´ì „ê³¼ ë™ì¼í•œ ìºë¦­í„° ì„ íƒ ê·¸ë¦¬ê¸° ë¡œì§ (ì¢Œí‘œ ê¸°ì¤€ë§Œ GAME_WIDTHë¡œ ë³€ê²½) ... */ });
            drawConfirmButton(GAME_HEIGHT * 0.8);
        }

        function drawMainMenu() {
            const titleFontSize = Math.min(GAME_WIDTH * 0.1, 48);
            ctx.fillStyle = '#2c3e50'; ctx.font = `bold ${titleFontSize}px Arial`; ctx.textAlign = 'center';
            ctx.fillText('ë¬¼ì²´ í”¼í•˜ê¸° ê²Œì„', GAME_WIDTH / 2, GAME_HEIGHT * 0.2);
            const btnWidth = Math.min(GAME_WIDTH * 0.7, 300);
            const btnHeight = Math.min(GAME_HEIGHT * 0.1, 60);
            const gap = btnHeight * 0.5; const totalBtnBlockHeight = (btnHeight * 3) + (gap * 2);
            const btnX = (GAME_WIDTH - btnWidth) / 2;
            let startY = (GAME_HEIGHT - totalBtnBlockHeight) * 0.6;
            if (startY < GAME_HEIGHT * 0.3) { startY = GAME_HEIGHT * 0.3; }
            const btnFontSize = Math.min(btnHeight * 0.4, 24);
            ctx.font = `bold ${btnFontSize}px Arial`;
            /* ... ì´ì „ê³¼ ë™ì¼í•œ ë²„íŠ¼ ê·¸ë¦¬ê¸° ë¡œì§ (ì¢Œí‘œ ê¸°ì¤€ë§Œ GAME_WIDTHë¡œ ë³€ê²½) ... */
        }
        
        function drawStartScreen() { uiBoxes = {}; if (startScreenState === 'main') { drawMainMenu(); } else if (startScreenState === 'leaderboard') { drawLeaderboardScreen(); } else if (startScreenState === 'characterSelect') { drawCharacterSelectScreen(); } }
        function drawPauseScreen() { /* ... */ }
        function drawGameOver() { /* ... */ }
        function drawUI(drawButton = true) { /* ... */ }
        function movePlayer() { /* ... */ }
        function updateObjects(deltaTime) { /* ... */ }
        async function handleInteractionStart(e) { /* ... */ }
        function handleInteractionMove(e) { /* ... */ }
        function handleInteractionEnd(e) { /* ... */ }
        function handleKeyDown(e) { /* ... */ }
        function handleKeyUp(e) { /* ... */ }
        function handleWheel(e) { /* ... */ }
        
        function gameLoop(timestamp) {
            cancelAnimationFrame(animationFrameId);
            if (gameState === 'loading') { drawCurrentState(); animationFrameId = requestAnimationFrame(gameLoop); return; }
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            if (gameState === 'playing') { updateObjects(deltaTime); movePlayer(); }
            drawCurrentState();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ê²Œì„ ì‹œì‘ì  ---
        window.addEventListener('resize', resizeCanvas);
        // (ì´í•˜ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì´ì „ê³¼ ë™ì¼)

        // (ì´í•˜ ëª¨ë“  ì´ˆê¸°í™” ë° ê²Œì„ ì‹œì‘ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼)
    </script>
</body>
</html>
