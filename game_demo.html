<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YEAH! We Are CLOVERs!</title>
    <style>
        @font-face {
            font-family: 'MyGameFont';
            src: url('./fonts/Pak_Yong_jun.ttf') format('truetype');
        }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <audio id="bgm" src="./Love3.mp3" loop></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ==================================================================
        // Firebase Config
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA90s1FUPCjbW3Wo_N8IVhMUqewmXhetq0",
            authDomain: "clovergame-e712f.firebaseapp.com",
            projectId: "clovergame-e712f",
            storageBucket: "clovergame-e712f.appspot.com",
            messagingSenderId: "525191060039",
            appId: "1:525191060039:web:5707417e6e8ee8bf9cef62"
        };
        // ==================================================================

        // --- 전역 변수 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgm = document.getElementById('bgm');
        
        const GAME_WIDTH = 540;
        const GAME_HEIGHT = 960;
        
        const BGM_VOLUME_NORMAL = 0.5;
        const BGM_VOLUME_MENU = BGM_VOLUME_NORMAL / 2;

        let db, leaderboardCollection, cachedLeaderboard = null;
        const characters = [
            { id: 1, name: 'PAIIEK', speed: 7, imgSrc: './char2.png', imgSrcSelected: './char2-1.png', imgIconSrc: './char2-2.png', imgHitSrc: './char2-3.png', img: null, imgSelected: null, imgIcon: null, imgHit: null, selectSfxSrc: './sounds/char2-1.mp3', hitSfxSrc: './sounds/char2-1-1.mp3', selectVolume: 0.8, hitVolume: 1.0 },
            { id: 2, name: 'KANG', speed: 8, imgSrc: './char3.png', imgSrcSelected: './char3-1.png', imgIconSrc: './char3-2.png', imgHitSrc: './char3-3.png', img: null, imgSelected: null, imgIcon: null, imgHit: null, selectSfxSrc: './sounds/char3-1.mp3', hitSfxSrc: './sounds/char3-1-1.mp3', selectVolume: 1.0, hitVolume: 1.0 },
            { id: 3, name: 'NAH', speed: 9, imgSrc: './char1.png', imgSrcSelected: './char1-1.png', imgIconSrc: './char1-2.png', imgHitSrc: './char1-3.png', img: null, imgSelected: null, imgIcon: null, imgHit: null, selectSfxSrc: './sounds/char1-1.mp3', hitSfxSrc: './sounds/char1-1-1.mp3', selectVolume: 0.5, hitVolume: 1.0 }
        ];
        let selectedCharacterId = 1;
        
        let uiBoxes = {}, startScreenState = 'main'; 
        let leaderboardScrollY = 0, isDragging = false, lastTouchY = 0;
        let player, objects, score, spawnTimer, targetX;
        let gameState = 'loading';
        let lastTime = 0, gameSpeedMultiplier = 1;
        let feverScore = 0, isFeverTime = false, feverTimer = 0;
        const FEVER_DURATION = 5000, FEVER_TRIGGER_COUNT = 10;
        const BASE_SPAWN_INTERVAL = 450, FEVER_SPAWN_INTERVAL = 120;
        let pauseButtonBox = {};
        let animationFrameId;
        
        let lives;
        const MAX_LIVES = 3;

        let cloverImg = new Image(), loveImg = new Image(), bombImg = new Image(), cloverTitleImg = new Image();
        let darkGrayBtnImg = new Image(), lightGrayBtnImg = new Image();
        let majorImg = new Image(), yellowImg = new Image(), grayImg = new Image();
        let hasInteracted = false;
        let isMuted = false;

        const BOMB_HIT_SFX_SRC = './sounds/bomb_hit.mp3';
        const BUTTON_CLICK_SFX_SRC = './sounds/button_click.mp3';
        const GAME_OVER_SFX_SRC = './sounds/game_over.mp3';
        
        function initializeFirebase() { /* 이전과 동일 */ }
        function listenForLeaderboardUpdates() { /* 이전과 동일 */ }
        async function saveToLeaderboard(newScore, nickname) { /* 이전과 동일 */ }
        function loadImages() { /* 이전과 동일 */ }
        function playSound(src, volume = 1.0) { /* 이전과 동일 */ }
        function init() { /* 이전과 동일 */ }
        function resizeCanvas() { /* 이전과 동일 */ }
        function drawCurrentState() {
            const rect = canvas.getBoundingClientRect();
            const bgColor = (gameState === 'playing' && isFeverTime) ? '#e8f5e9' : '#f0f0f0';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, rect.width, rect.height);
            if (gameState === 'loading') { ctx.fillStyle = 'black'; ctx.font = '24px "MyGameFont"'; ctx.textAlign = 'center'; ctx.fillText('로딩 중...', rect.width / 2, rect.height / 2); }
            else if (gameState === 'startScreen') { drawStartScreen(); }
            else if (gameState === 'playing') { drawObjects(); drawPlayer(); drawUI(); }
            else if (gameState === 'paused') { drawPauseScreen(); }
            else if (gameState === 'gameOver') { drawGameOver(); }
        }
        function getEventPos(e) { /* 이전과 동일 */ }
        function isInside(pos, rect) { /* 이전과 동일 */ }
        function drawPlayer() { /* 이전과 동일 */ }
        function drawObjects() { /* 이전과 동일 */ }
        function drawConfirmButton(yPos) { /* 이전과 동일 */ }
        function drawLeaderboardScreen() { /* 이전과 동일 */ }
        function drawCharacterSelectScreen() { /* 이전과 동일 */ }

        function drawMainMenu() {
            const rect = canvas.getBoundingClientRect();
            let currentY = rect.height * 0.1;
            if (cloverTitleImg.complete && cloverTitleImg.naturalWidth > 0) {
                const imgWidth = rect.width * 0.7; 
                const imgHeight = (cloverTitleImg.naturalHeight / cloverTitleImg.naturalWidth) * imgWidth;
                const imgX = (rect.width - imgWidth) / 2;
                ctx.drawImage(cloverTitleImg, imgX, currentY, imgWidth, imgHeight);
                currentY += imgHeight + 20;
            }
            ctx.fillStyle = '#2c3e50'; ctx.font = '18px "MyGameFont"'; ctx.textAlign = 'center';
            const lineHeight = 28; const iconSize = 20;
            currentY += 20;
            ctx.fillText('<게임방법>', rect.width / 2, currentY);
            currentY += lineHeight * 1.5;
            function drawLineWithIconAndColor(text, icon, y, textColor = '#2c3e50') { const textWidth = ctx.measureText(text).width; const totalWidth = iconSize + 5 + textWidth; const startX = (rect.width - totalWidth) / 2; if (icon && icon.complete) { ctx.drawImage(icon, startX, y - iconSize, iconSize, iconSize); } ctx.textAlign = 'left'; ctx.fillStyle = textColor; ctx.fillText(text, startX + iconSize + 5, y); ctx.fillStyle = '#2c3e50'; }
            ctx.textAlign = 'left';
            drawLineWithIconAndColor('를 많이 받아 점수를 내는 게임입니다!', cloverImg, currentY);
            currentY += lineHeight;
            const line2_part1 = '를 10번 받아 '; const line2_part2 = 'LOVE'; const line2_part3 = ' 게이지가 가득 차면';
            const line2_part1Width = ctx.measureText(line2_part1).width; const line2_part2Width = ctx.measureText(line2_part2).width;
            const line2TotalWidth = iconSize + 5 + line2_part1Width + line2_part2Width + ctx.measureText(line2_part3).width;
            const line2StartX = (rect.width - line2TotalWidth) / 2;
            if (loveImg.complete) ctx.drawImage(loveImg, line2StartX, currentY - iconSize, iconSize, iconSize);
            ctx.textAlign = 'left'; ctx.fillStyle = '#2c3e50';
            ctx.fillText(line2_part1, line2StartX + iconSize + 5, currentY);
            ctx.fillStyle = '#ff69b4';
            ctx.fillText(line2_part2, line2StartX + iconSize + 5 + line2_part1Width, currentY);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText(line2_part3, line2StartX + iconSize + 5 + line2_part1Width + line2_part2Width, currentY);
            currentY += lineHeight;
            const text1 = "CLOVER TIME"; const text2 = "이 발동합니다";
            const text1Width = ctx.measureText(text1).width; const totalTextWidth = text1Width + ctx.measureText(text2).width;
            let textStartX = (rect.width - totalTextWidth) / 2;
            ctx.textAlign = 'left'; ctx.fillStyle = '#27ae60';
            ctx.fillText(text1, textStartX, currentY);
            ctx.fillStyle = '#2c3e50'; ctx.fillText(text2, textStartX + text1Width, currentY);
            currentY += lineHeight;
            const line4_part1 = '를 세 번 받으면 '; const line4_part2 = 'GAME OVER!';
            const line4_part1Width = ctx.measureText(line4_part1).width; const line4TotalWidth = iconSize + 5 + line4_part1Width + ctx.measureText(line4_part2).width;
            const line4StartX = (rect.width - line4TotalWidth) / 2;
            if (bombImg.complete) ctx.drawImage(bombImg, line4StartX, currentY - iconSize, iconSize, iconSize);
            ctx.textAlign = 'left'; ctx.fillStyle = '#2c3e50';
            ctx.fillText(line4_part1, line4StartX + iconSize + 5, currentY);
            ctx.fillStyle = 'red'; ctx.fillText(line4_part2, line4StartX + iconSize + 5 + line4_part1Width, currentY);
            ctx.fillStyle = '#2c3e50';
            currentY += lineHeight;
            ctx.textAlign = 'center';
            const line5_part1 = "점수가 TOP 10 안에 든다면 "; const line5_part2 = "명예의 전당"; const line5_part3 = "에 이름을 올릴 수 있습니다";
            const line5_part1Width = ctx.measureText(line5_part1).width; const line5_part2Width = ctx.measureText(line5_part2).width;
            const line5TotalWidth = line5_part1Width + line5_part2Width + ctx.measureText(line5_part3).width;
            const line5StartX = (rect.width - line5TotalWidth) / 2;
            ctx.textAlign = 'left'; ctx.fillText(line5_part1, line5StartX, currentY);
            ctx.fillStyle = '#e67e22'; ctx.fillText(line5_part2, line5StartX + line5_part1Width, currentY);
            ctx.fillStyle = '#2c3e50'; ctx.fillText(line5_part3, line5StartX + line5_part1Width + line5_part2Width, currentY);
            currentY += lineHeight;
            ctx.textAlign = 'center';
            ctx.fillText('재미있게 즐겨주세요!❤️', rect.width / 2, currentY);
            currentY += 40;
            const btnWidth = Math.min(rect.width * 0.7, 300); const btnHeight = Math.min(rect.height * 0.08, 60);
            const gap = btnHeight * 0.5;
            const btnX = (rect.width - btnWidth) / 2;
            const btnFontSize = Math.min(btnHeight * 0.4, 24); ctx.font = `bold ${btnFontSize}px "MyGameFont"`;
            let buttonStartY = currentY;
            uiBoxes.charSelectBtn = { x: btnX, y: buttonStartY, width: btnWidth, height: btnHeight };
            if (darkGrayBtnImg.complete) ctx.drawImage(darkGrayBtnImg, btnX, buttonStartY, btnWidth, btnHeight);
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText('캐릭터 선택', rect.width / 2, buttonStartY + btnHeight / 2 + (btnFontSize / 3));
            uiBoxes.leaderboardBtn = { x: btnX, y: buttonStartY + btnHeight + gap, width: btnWidth, height: btnHeight };
            if (lightGrayBtnImg.complete) ctx.drawImage(lightGrayBtnImg, btnX, buttonStartY + btnHeight + gap, btnWidth, btnHeight);
            ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText('명예의 전당', rect.width / 2, buttonStartY + btnHeight + gap + btnHeight / 2 + (btnFontSize / 3));
            uiBoxes.startBtn = { x: btnX, y: buttonStartY + (btnHeight + gap) * 2, width: btnWidth, height: btnHeight };
            if (darkGrayBtnImg.complete) ctx.drawImage(darkGrayBtnImg, btnX, buttonStartY + (btnHeight + gap) * 2, btnWidth, btnHeight);
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText('게임 시작', rect.width / 2, buttonStartY + (btnHeight + gap) * 2 + btnHeight / 2 + (btnFontSize / 3));
            
            // Credit 버튼
            const creditBtnWidth = 100; const creditBtnHeight = 40;
            const creditBtnX = rect.width - creditBtnWidth - 15;
            const creditBtnY = rect.height - creditBtnHeight - 15;
            uiBoxes.creditBtn = { x: creditBtnX, y: creditBtnY, width: creditBtnWidth, height: creditBtnHeight };
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(creditBtnX, creditBtnY, creditBtnWidth, creditBtnHeight);
            ctx.fillStyle = '#333';
            ctx.font = '16px "MyGameFont"';
            ctx.fillText('CREDIT', creditBtnX + creditBtnWidth / 2, creditBtnY + creditBtnHeight / 2 + 6);
        }

        // ✨ Credit 화면 그리기 함수 추가
        function drawCreditScreen() {
            const rect = canvas.getBoundingClientRect();
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 32px "MyGameFont"';
            ctx.textAlign = 'center';
            ctx.fillText('CREDIT', rect.width / 2, rect.height * 0.15);

            let currentY = rect.height * 0.3;
            const lineHeight = 30;
            const sectionGap = 40;
            
            ctx.font = 'bold 20px "MyGameFont"';
            ctx.fillText('Made by', rect.width / 2, currentY);
            currentY += lineHeight;
            ctx.font = '18px "MyGameFont"';
            ctx.fillText('@chakoll23', rect.width / 2, currentY);
            currentY += sectionGap;

            ctx.font = 'bold 20px "MyGameFont"';
            ctx.fillText('SFX provided by', rect.width / 2, currentY);
            currentY += lineHeight;
            ctx.font = '18px "MyGameFont"';
            ctx.fillText('셀바이뮤직', rect.width / 2, currentY);
            currentY += sectionGap;

            ctx.font = 'bold 20px "MyGameFont"';
            ctx.fillText('Voice', rect.width / 2, currentY);
            currentY += lineHeight;
            ctx.font = '18px "MyGameFont"';
            ctx.fillText('백승렬, 강현웅, 나상현', rect.width / 2, currentY);
            currentY += sectionGap;
            
            ctx.font = 'bold 20px "MyGameFont"';
            ctx.fillText('BGM', rect.width / 2, currentY);
            currentY += lineHeight;
            ctx.font = '18px "MyGameFont"';
            ctx.fillText("'Love Love Love (Chiptune ver.)' - 나상현", rect.width / 2, currentY);
            
            drawConfirmButton(rect.height * 0.85);
        }
        
        function drawStartScreen() { uiBoxes = {}; const rect = canvas.getBoundingClientRect(); ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0, 0, rect.width, rect.height); if (startScreenState === 'main') { drawMainMenu(); } else if (startScreenState === 'leaderboard') { drawLeaderboardScreen(); } else if (startScreenState === 'characterSelect') { drawCharacterSelectScreen(); } else if (startScreenState === 'credit') { drawCreditScreen(); } }
        
        function drawPauseScreen() { /* 이전과 동일 */ }
        function drawGameOver() { /* 이전과 동일 */ }
        function drawUI(drawButton = true) { /* 이전과 동일 */ }
        function movePlayer() { /* 이전과 동일 */ }
        function updateObjects(deltaTime) { /* 이전과 동일 */ }
        
        async function handleInteractionStart(e) {
            e.preventDefault(); const pos = getEventPos(e);
            if (!hasInteracted) {
                hasInteracted = true;
                bgm.volume = BGM_VOLUME_MENU;
                bgm.loop = true;
                bgm.play().catch(()=>{});
            }
            if (gameState === 'startScreen') {
                if (startScreenState === 'main') {
                    if (isInside(pos, uiBoxes.charSelectBtn)) { playSound(BUTTON_CLICK_SFX_SRC); startScreenState = 'characterSelect'; }
                    else if (isInside(pos, uiBoxes.leaderboardBtn)) { playSound(BUTTON_CLICK_SFX_SRC); leaderboardScrollY = 0; startScreenState = 'leaderboard'; }
                    else if (isInside(pos, uiBoxes.startBtn)) { playSound(BUTTON_CLICK_SFX_SRC); init(); }
                    else if (isInside(pos, uiBoxes.creditBtn)) { playSound(BUTTON_CLICK_SFX_SRC); startScreenState = 'credit'; }
                } else {
                    if (startScreenState === 'characterSelect') { 
                        uiBoxes.characterBoxes.forEach(box => { 
                            if (isInside(pos, box) && selectedCharacterId !== box.id) {
                                selectedCharacterId = box.id;
                                const selectedChar = characters.find(c => c.id === selectedCharacterId);
                                if (selectedChar) playSound(selectedChar.selectSfxSrc, selectedChar.selectVolume);
                            }
                        }); 
                    }
                    if (isInside(pos, uiBoxes.confirmBtn)) { playSound(BUTTON_CLICK_SFX_SRC); startScreenState = 'main'; leaderboardScrollY = 0; }
                    if (startScreenState === 'leaderboard' || startScreenState === 'credit') { 
                        isDragging = (startScreenState === 'leaderboard');
                        if (isDragging) lastTouchY = pos.y;
                        if (isInside(pos, uiBoxes.confirmBtn)) { playSound(BUTTON_CLICK_SFX_SRC); startScreenState = 'main'; leaderboardScrollY = 0; } 
                    }
                }
            } else if (gameState === 'playing') {
                if (isInside(pos, pauseButtonBox)) { playSound(BUTTON_CLICK_SFX_SRC); gameState = 'paused'; bgm.pause(); }
                else { player.dx = 0; targetX = pos.x - player.width / 2; }
            } else if (gameState === 'paused') {
                if (isInside(pos, uiBoxes.resumeBtn)) { playSound(BUTTON_CLICK_SFX_SRC); gameState = 'playing'; bgm.volume = BGM_VOLUME_NORMAL; bgm.play(); }
                else if (isInside(pos, uiBoxes.toMainBtn)) { playSound(BUTTON_CLICK_SFX_SRC); gameState = 'startScreen'; startScreenState = 'main'; bgm.volume = BGM_VOLUME_MENU; }
            } else if (gameState === 'gameOver') {
                const nickname = prompt(`게임 오버!\n최종 점수: ${score}\n\n순위에 등록할 닉네임을 입력하세요:`, '');
                if (nickname && nickname.trim() !== '') { await saveToLeaderboard(score, nickname.trim()); }
                gameState = 'startScreen'; startScreenState = 'main'; lastTime = 0;
                bgm.volume = BGM_VOLUME_MENU;
                if (bgm.paused) { bgm.play(); }
            }
        }
        
        function handleInteractionMove(e) { /* 이전과 동일 */ }
        function handleInteractionEnd(e) { /* 이전과 동일 */ }
        function handleKeyDown(e) { /* 이전과 동일 */ }
        function handleKeyUp(e) { /* 이전과 동일 */ }
        function handleWheel(e) { /* 이전과 동일 */ }
        function gameLoop(timestamp) { /* 이전과 동일 */ }

        // --- 이벤트 리스너 및 게임 시작점 ---
        // (이전과 동일)
    </script>
</body>
</html>
